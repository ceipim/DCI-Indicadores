<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Livro de NCMs</title>
    <style>
        :root {
            --color-bg: #f0f4f8;
            --color-bg-light: #ffffff;
            --color-primary: #0056b3;
            --color-primary-dark: #004085;
            --color-text: #333;
            --color-border: #ddd;
            --color-shadow: rgba(0, 0, 0, 0.1);
            --font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { -webkit-text-size-adjust: 100%; }
        
        body {
            font-family: var(--font-family);
            background-image: linear-gradient(120deg, #9370DB 0%, #6495ED 100%);
            background-attachment: fixed;
            color: var(--color-text);
            line-height: 1.5;
            padding: 0.5rem 1rem 5rem 1rem;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1450px;
            margin: 0 auto;
            padding: 1rem;
            flex-grow: 1;
        }

        h1 {
            text-align: center;
            color: var(--color-bg-light);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-size: 2.2rem;
            margin-bottom: 1rem;
        }

        #dataSourceInfo, #databaseStatsInfo {
            text-align: center;
            color: #f0f4f8;
            font-style: italic;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            margin-bottom: 0.5rem;
        }

        .card {
            background: var(--color-bg-light);
            border-radius: 12px;
            box-shadow: 0 6px 12px var(--color-shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--color-border);
        }

        /* ========== CONTROLES ========== */
        .livro-search-container {
            margin-bottom: 16px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .livro-search-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }
        .livro-search-input:focus { border-color: var(--color-primary); }
        .livro-search-button {
            padding: 8px 16px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .livro-search-button:hover { background: var(--color-primary-dark); }
        
        .livro-expand-controls {
            margin-bottom: 16px;
            text-align: center;
        }
        .livro-expand-btn {
            padding: 5px 14px;
            margin: 0 4px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .livro-expand-btn:hover { background: #5a6268; }

        /* ========== ÁRVORE NCM (CSS CORRIGIDO) ========== */
        
        /* 1. RESET DE MARGEM ESTRUTURAL */
        /* Remove recuo automático dos containers para permitir controle manual absoluto */
        #aba-livro .ncm-node { margin: 1px 0; border: none; }
        #aba-livro .children { margin-left: 0 !important; padding-left: 0 !important; display: none; }
        #aba-livro .children.expanded { display: block; }

        /* 2. CABEÇALHO GERAL */
        #aba-livro .ncm-header {
            display: flex;
            align-items: center;
            padding: 4px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.15s;
            min-height: 24px;
        }
        #aba-livro .ncm-header:hover { filter: brightness(0.95); }

        /* 3. RECUOS ABSOLUTOS (A ESCADA HIERÁRQUICA) */
        /* Cada nível tem sua distância fixa da borda esquerda */

        /* Seção */
        #aba-livro .secao > .ncm-header { 
            margin-left: 0px; 
            background-color: #e8eaf6; border-left: 5px solid #3f51b5;
        }
        
        /* Capítulo (2 dígitos) - Ex: 01 */
        #aba-livro .capitulo > .ncm-header { 
            margin-left: 20px; 
            background-color: #e3f2fd; border-left: 4px solid #2196F3;
        }

        /* Posição (4 dígitos) - Ex: 01.01 */
        #aba-livro .posicao > .ncm-header { 
            margin-left: 40px; 
            background-color: #ffebee; border-left: 4px solid #c62828;
        }

        /* Subposição (5 ou 6 dígitos) - Ex: 0101.2 ou 0102.21 */
        #aba-livro .subposicao > .ncm-header { 
            margin-left: 70px; 
            background-color: #fff3e0; border-left: 4px solid #FF9800;
        }

        /* Subitem (7 dígitos) - Ex: 0102.29.1 */
        #aba-livro .subitem7 > .ncm-header { 
            margin-left: 100px; /* Recuo X */
            background-color: #f1f8e9; border-left: 4px solid #8bc34a;
        }

        /* Item (8 dígitos) - Ex: 0102.29.11 */
        /* AQUI ESTÁ O AJUSTE QUE VOCÊ PEDIU: X + 10px */
        #aba-livro .item > .ncm-header { 
            margin-left: 130px; /* 100px + 30px = 130px */
            background-color: #e8f5e9; border-left: 4px solid #2e7d32;
            font-weight: 500;
        }

        /* 4. TIPOGRAFIA */
        #aba-livro .codigo {
            font-weight: bold;
            min-width: 100px;
            margin-right: 8px;
            flex-shrink: 0;
            font-size: 0.9rem;
        }
        #aba-livro .secao-tracinho { margin-right: 6px; font-weight: bold; }
        #aba-livro .descricao { flex-grow: 1; white-space: normal; font-size: 0.9rem; }
        #aba-livro .highlight { background-color: #ffeb3b !important; color: #333; padding: 0 2px; border-radius: 2px; }
        #aba-livro .no-children .ncm-header { cursor: default; }

        /* ========== OUTROS ========== */
        .page-footer { display: flex; justify-content: space-between; padding: 1rem; color: #f0f4f8; font-size: 0.8rem; }
        #updateLink { color: #f0f4f8; text-decoration: none; opacity: 0.8; }
        #backToTop {
            position: fixed; bottom: 20px; right: 20px; width: 44px; height: 44px;
            background: var(--color-primary); color: white; border: none; border-radius: 50%;
            cursor: pointer; display: none; align-items: center; justify-content: center;
            font-size: 18px; z-index: 900;
        }
        #backToTop.show { display: flex; }
        #toastContainer { position: fixed; bottom: 80px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 8px 14px; border-radius: 6px; color: white; background: var(--color-primary); opacity: 0; transform: translateX(100%); transition: 0.4s; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.error { background: #d32f2f; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Livro de NCMs</h1>
        <p id="dataSourceInfo">Carregando base de dados...</p>
        <p id="databaseStatsInfo"></p>
        
        <div id="aba-livro">
            <div class="card">
                <div class="livro-search-container">
                    <input type="text" class="livro-search-input" id="livroSearchInput" placeholder="Buscar código ou descrição...">
                    <button class="livro-search-button" id="livroSearchBtn">Buscar</button>
                </div>
                <div class="livro-expand-controls">
                    <button class="livro-expand-btn" id="livroExpandSecoesBtn">Expandir Seções</button>
                    <button class="livro-expand-btn" id="livroCollapseBtn">Recolher Tudo</button>
                </div>
                <div id="livroTreeContainer">
                    <p style="text-align:center; padding: 20px;">Aguardando dados...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="page-footer">
        <a href="#" id="updateLink">Atualizar Base</a>
        <p>&copy; 2025 Livro NCM</p>
    </div>
    <button id="backToTop" title="Voltar ao topo">↑</button>
    <div id="toastContainer"></div>

    <script>
        const CSV_FILE = 'Tabela_NCM_Vigente.csv';
        const livroTreeContainer = document.getElementById('livroTreeContainer');
        const livroSearchInput = document.getElementById('livroSearchInput');
        const dataSourceInfo = document.getElementById('dataSourceInfo');
        const databaseStatsInfo = document.getElementById('databaseStatsInfo');
        const backToTopBtn = document.getElementById('backToTop');

        let ncmTreeMap = new Map();
        let livroNcmData = [];

        window.addEventListener('scroll', () => {
            backToTopBtn.classList.toggle('show', window.scrollY > 300);
        });
        backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('livroSearchBtn').addEventListener('click', searchNCM_Livro);
            document.getElementById('livroExpandSecoesBtn').addEventListener('click', expandSecoes_Livro);
            document.getElementById('livroCollapseBtn').addEventListener('click', collapseAll_Livro);
            livroSearchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') searchNCM_Livro(); });
            loadData();
        });

        async function loadData() {
            try {
                const resp = await fetch(CSV_FILE + '?' + Date.now());
                if (!resp.ok) throw new Error('Erro ao abrir arquivo CSV.');
                
                let text = await resp.text();
                // Fallback de encoding
                if (!text.includes('Código') && !text.includes('Descri')) {
                    const decoder = new TextDecoder('iso-8859-1');
                    text = decoder.decode(await resp.arrayBuffer());
                }

                const lines = text.split(/\r?\n/);
                let hIdx = lines.findIndex(l => l.toLowerCase().includes('código') && l.toLowerCase().includes('descri'));
                if (hIdx === -1) throw new Error('Cabeçalhos não encontrados.');

                const sep = lines[hIdx].includes(';') ? ';' : ',';
                const headers = lines[hIdx].split(sep).map(h => h.replace(/"/g, '').trim());
                const idxCode = headers.findIndex(h => /c[oó]digo/i.test(h));
                const idxDesc = headers.findIndex(h => /descri/i.test(h));

                const tree = new Map();
                let count = 0;

                for (let i = hIdx + 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    const row = parseRow(lines[i], sep);
                    if (row.length <= Math.max(idxCode, idxDesc)) continue;

                    const rawCode = row[idxCode];
                    const cleanCode = rawCode.replace(/\D/g, ''); // Somente números para chave
                    const desc = row[idxDesc].replace(/<\/?[^>]+>/g, '');

                    if (cleanCode.length === 8) count++;

                    // Usamos cleanCode como CHAVE ÚNICA para garantir conexões
                    if (!tree.has(cleanCode)) {
                        tree.set(cleanCode, { 
                            cleanCode: cleanCode, // Chave pura (ex: 01012100)
                            displayCode: rawCode, // Visual (ex: 0101.21.00)
                            desc: desc, 
                            children: [] 
                        });
                    }
                }

                ncmTreeMap = tree;

                // Monta a árvore usando chaves limpas
                tree.forEach((node, key) => {
                    // Não buscamos pai para Capítulos (2 dig), pois o pai é a Seção
                    if (key.length > 2) {
                        const parentKey = findParentKey(key, tree);
                        if (parentKey && tree.has(parentKey)) {
                            tree.get(parentKey).children.push(node);
                        }
                    }
                });

                buildLivroData();
                dataSourceInfo.textContent = `Base: ${CSV_FILE}`;
                databaseStatsInfo.textContent = `${count.toLocaleString('pt-BR')} itens carregados.`;
                collapseAll_Livro();
                showToast('Dados carregados!', 'success');

            } catch (e) {
                console.error(e);
                dataSourceInfo.textContent = 'Erro na carga.';
                showToast(e.message, 'error');
            }
        }

        // Lógica "Inteligente" para achar o pai
        // Procura o pai imediato. Se não achar, tenta o nível acima (para casos onde o CSV pula níveis)
        function findParentKey(childKey, tree) {
            const len = childKey.length;
            
            // Se sou 8 (Item), tento achar pai 7 (Subitem). Se não tiver, tento 6 (Subpos), etc.
            if (len === 8) {
                if (tree.has(childKey.substring(0, 7))) return childKey.substring(0, 7);
                if (tree.has(childKey.substring(0, 6))) return childKey.substring(0, 6);
                if (tree.has(childKey.substring(0, 5))) return childKey.substring(0, 5);
                if (tree.has(childKey.substring(0, 4))) return childKey.substring(0, 4);
            }
            
            // Se sou 7 (Subitem), tento achar pai 6. Se não, 5...
            if (len === 7) {
                if (tree.has(childKey.substring(0, 6))) return childKey.substring(0, 6);
                if (tree.has(childKey.substring(0, 5))) return childKey.substring(0, 5);
                if (tree.has(childKey.substring(0, 4))) return childKey.substring(0, 4);
            }

            // Se sou 6 (Subposição), tento achar pai 5. Se não, 4.
            if (len === 6) {
                if (tree.has(childKey.substring(0, 5))) return childKey.substring(0, 5);
                if (tree.has(childKey.substring(0, 4))) return childKey.substring(0, 4);
            }

            // Se sou 5 (Subposição curta), tento pai 4.
            if (len === 5) {
                if (tree.has(childKey.substring(0, 4))) return childKey.substring(0, 4);
            }

            // Se sou 4 (Posição), tento pai 2 (Capítulo).
            if (len === 4) {
                if (tree.has(childKey.substring(0, 2))) return childKey.substring(0, 2);
            }

            return null;
        }

        function parseRow(line, sep) {
            const out = [];
            let curr = '';
            let inQ = false;
            for (let c of line) {
                if (c === '"') inQ = !inQ;
                else if (c === sep && !inQ) { out.push(curr); curr = ''; }
                else curr += c;
            }
            out.push(curr);
            return out.map(s => s.trim().replace(/^"|"$/g, ''));
        }

        const secoesNCM = {
            "I": { nome: "ANIMAIS VIVOS E PRODUTOS DO REINO ANIMAL", caps: ["01","02","03","04","05"] },
            "II": { nome: "PRODUTOS DO REINO VEGETAL", caps: ["06","07","08","09","10","11","12","13","14"] },
            "III": { nome: "GORDURAS E ÓLEOS", caps: ["15"] },
            "IV": { nome: "INDÚSTRIAS ALIMENTARES", caps: ["16","17","18","19","20","21","22","23","24"] },
            "V": { nome: "PRODUTOS MINERAIS", caps: ["25","26","27"] },
            "VI": { nome: "INDÚSTRIAS QUÍMICAS", caps: ["28","29","30","31","32","33","34","35","36","37","38"] },
            "VII": { nome: "PLÁSTICO E BORRACHA", caps: ["39","40"] },
            "VIII": { nome: "PELES E COUROS", caps: ["41","42","43"] },
            "IX": { nome: "MADEIRA E CARVÃO", caps: ["44","45","46"] },
            "X": { nome: "PAPEL E CARTÃO", caps: ["47","48","49"] },
            "XI": { nome: "MATÉRIAS TÊXTEIS", caps: ["50","51","52","53","54","55","56","57","58","59","60","61","62","63"] },
            "XII": { nome: "CALÇADOS E CHAPÉUS", caps: ["64","65","66","67"] },
            "XIII": { nome: "OBRAS DE PEDRA E CIMENTO", caps: ["68","69","70"] },
            "XIV": { nome: "PEDRAS PRECIOSAS", caps: ["71"] },
            "XV": { nome: "METAIS COMUNS", caps: ["72","73","74","75","76","78","79","80","81","82","83"] },
            "XVI": { nome: "MÁQUINAS E MATERIAL ELÉTRICO", caps: ["84","85"] },
            "XVII": { nome: "MATERIAL DE TRANSPORTE", caps: ["86","87","88","89"] },
            "XVIII": { nome: "INSTRUMENTOS DE ÓPTICA", caps: ["90","91","92"] },
            "XIX": { nome: "ARMAS E MUNIÇÕES", caps: ["93"] },
            "XX": { nome: "MERCADORIAS DIVERSAS", caps: ["94","95","96"] },
            "XXI": { nome: "OBJETOS DE ARTE", caps: ["97"] }
        };

        function buildLivroData() {
            livroNcmData = [];
            for (const secaoId in secoesNCM) {
                const secao = secoesNCM[secaoId];
                const secaoNode = {
                    displayCode: secaoId,
                    desc: secao.nome,
                    nivel: 'secao',
                    children: []
                };
                secao.caps.forEach(capId => {
                    // Busca pela chave limpa (2 dígitos)
                    const capNode = ncmTreeMap.get(capId);
                    if (capNode) {
                        secaoNode.children.push(buildNodeRecursive(capNode));
                    }
                });
                secaoNode.children.sort((a, b) => a.cleanCode.localeCompare(b.cleanCode));
                livroNcmData.push(secaoNode);
            }
        }

        function buildNodeRecursive(node) {
            const len = node.cleanCode.length;
            let nivel;
            
            // Classificação para CSS
            if (len === 2) nivel = 'capitulo';
            else if (len === 4) nivel = 'posicao';
            else if (len === 5 || len === 6) nivel = 'subposicao';
            else if (len === 7) nivel = 'subitem7';
            else if (len === 8) nivel = 'item';
            else nivel = 'item';

            const newNode = {
                cleanCode: node.cleanCode,
                displayCode: node.displayCode,
                desc: node.desc,
                nivel: nivel,
                children: []
            };

            if (node.children && node.children.length > 0) {
                // Ordena filhos numéricos
                const sortedChildren = [...node.children].sort((a, b) => a.cleanCode.localeCompare(b.cleanCode));
                for (const child of sortedChildren) {
                    newNode.children.push(buildNodeRecursive(child));
                }
            }
            return newNode;
        }

        function renderNCM_Livro(nodes, parentEl, expandDepth = 0) {
            if (!nodes || nodes.length === 0) return;
            for (const node of nodes) {
                const el = document.createElement('div');
                el.className = `ncm-node ${node.nivel}`;
                
                const header = document.createElement('div');
                header.className = 'ncm-header';

                let codeText = node.displayCode;
                let tracinho = '';
                if (node.nivel === 'secao') {
                    codeText = `Seção ${node.displayCode}`;
                    tracinho = '<span class="secao-tracinho">-</span>';
                } else if (node.nivel === 'capitulo') {
                    codeText = `Capítulo ${node.displayCode}`;
                }

                header.innerHTML = `<span class="codigo">${codeText}</span>${tracinho}<span class="descricao">${node.desc}</span>`;
                
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'children';
                
                el.appendChild(header);
                el.appendChild(childrenContainer);
                parentEl.appendChild(el);

                if (node.children && node.children.length > 0) {
                    if (expandDepth > 0) {
                        childrenContainer.classList.add('expanded');
                        renderNCM_Livro(node.children, childrenContainer, expandDepth - 1);
                    }
                    header.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isExp = childrenContainer.classList.toggle('expanded');
                        if (isExp && childrenContainer.childElementCount === 0) {
                            renderNCM_Livro(node.children, childrenContainer, 0);
                        }
                    });
                } else {
                    el.classList.add('no-children');
                }
            }
        }

        function searchNCM_Livro() {
            const q = livroSearchInput.value.trim();
            livroTreeContainer.innerHTML = '';
            if (!q) return collapseAll_Livro();
            const results = searchTree(livroNcmData, q);
            if (results.length === 0) livroTreeContainer.innerHTML = '<p style="padding:16px;">Nenhum resultado.</p>';
            else { renderNCM_Livro(results, livroTreeContainer, 99); highlight(q); }
        }

        function searchTree(nodes, query) {
            const q = query.toLowerCase();
            let results = [];
            for (const node of nodes) {
                const match = node.displayCode.toLowerCase().includes(q) || node.desc.toLowerCase().includes(q);
                let childMatches = [];
                if (node.children && node.children.length > 0) childMatches = searchTree(node.children, query);
                if (match || childMatches.length > 0) results.push({ ...node, children: childMatches });
            }
            return results;
        }

        function highlight(query) {
            try {
                const reg = new RegExp(`(${query})`, 'gi');
                livroTreeContainer.querySelectorAll('.codigo, .descricao').forEach(el => {
                    el.innerHTML = el.textContent.replace(reg, '<span class="highlight">$1</span>');
                });
            } catch(e){}
        }

        function expandSecoes_Livro() { livroTreeContainer.innerHTML = ''; renderNCM_Livro(livroNcmData, livroTreeContainer, 1); }
        function collapseAll_Livro() { livroTreeContainer.innerHTML = ''; renderNCM_Livro(livroNcmData, livroTreeContainer, 0); }
        
        function showToast(msg, type = 'info') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => t.classList.add('show'), 10);
            setTimeout(() => { t.classList.remove('show'); t.addEventListener('transitionend', () => t.remove()); }, 3000);
        }
    </script>
</body>
</html>